<!doctype html>
<html lang="en">
<head>
    <title><<<buffer-title>>></title>
        <style>
         html {
             overflow: auto;
         }
         html, body, div, iframe {
             margin: 0px;
             padding: 0px;
             width: 100%;
             height: 100%;
             border-width: 0;
         }
         iframe {
             display: block;
             overflow: auto;
         }
        </style>
</head>

<body>
    <iframe id="content" src="<<<buffer-src-nowait>>>" seamless scrolling="auto"></iframe>

    <script>
     const max_period = 90000;
     const min_period = 5000;
     const alpha = 1.2;

     let current_id = '-1';
     let next_period = min_period;

     let nextTimeout = function() {
         let next = next_period;
         next_period = Math.min(max_period, next_period * alpha);
         return next;
     };

     let resetTimeout = function() {
         next_period = min_period;
     };

     let refreshIframe = function (data) {
         // origin
         const ori = document.querySelector('#content'),
               offX = ori.contentWindow.pageXOffset,
               offY = ori.contentWindow.pageYOffset;

         // recreate iframe
         let ifrm = document.createElement('iframe');
         ifrm.id = 'content';
         ifrm.src = ori.getAttribute('src');
         ifrm.seamless = ori.seamless;
         ori.parentNode.replaceChild(ifrm, ori);

         // init document
         let doc  = ifrm.contentDocument, win  = ifrm.contentWindow;
         printDoc(doc, data);
         doc.addEventListener('keyup', keyPressEvent);

         // fix position
         if(offY && offY >= doc.body.height - win.height) offY = null;
         win.scrollTo(offX, offY != null ? offY : doc.body.height);
     };

     let printDoc = function(doc, data) {
         doc.open();
         doc.write(data);
         doc.close();
     };

     let keyPressEvent = function(e) {
         if (e.key == 'h' && e.altKey) {
             window.location.replace('/imp');
         }
     };

     let setIframe = function(count, newText) {
         if(count) {
             current_id = count;
             refreshIframe(newText);
             lastText = newText;
         } else {
             refreshIframe('0', 'error parsing the response from emacs');
         }
     };

     let refresh = function() {
         let url = '<<<buffer-src>>>?id=' + current_id;

         fetch(url).then((resp) => {
             if (!resp.ok) {
                 throw new Error(resp.status);
             }
             resp.text().then((data) => {
                 resetTimeout();
                 setIframe(resp.headers.get("X-Imp-Count"), data);
                 refresh();
             });

         }).catch((err) => {
             console.log('Impatient~', err.message);
             setTimeout(refresh, nextTimeout());
         });
     };

     refresh();

     document.addEventListener('keyup', keyPressEvent);
    </script>
</body>
</html>
